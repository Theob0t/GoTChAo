name: GoTChAo CI/CD

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    # 1. Checkout your code
    - name: Checkout Code
      uses: actions/checkout@v4

    # 2. Set up Rust (to compile your binary)
    - name: Set up Rust
      uses: dtolnay/rust-toolchain@stable

    # 3. Build Rust Project
    - name: Build Rust
      run: cargo build --release

    # 4. Set up Python (for your scripts)
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    # 5. Install Apptainer (Singularity)
    # This replaces 'conda activate squashfuse-default'
    - name: Install Apptainer
      uses: eWaterCycle/setup-apptainer@v2
      with:
        apptainer-version: '1.2.5'

    # 6. Build the Container
    # We build it fresh every time to ensure the recipe works
    - name: Build Singularity Container
      run: |
        apptainer build gotchao.sif Singularity.def

    # 7. Run Your Test Script
    # We make the script executable and run it
    - name: Run Integration Test
      run: |
        chmod +x tests/run_test.sh
        # We run it from the root so relative paths (like python/...) work
        ./tests/run_test.sh