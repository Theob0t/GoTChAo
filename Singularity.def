Bootstrap: docker
From: python:3.9-slim

%labels
    Description GoTChAo Pipeline

%post
    apt-get update && apt-get install -y \
        build-essential curl pkg-config libssl-dev git \
        && rm -rf /var/lib/apt/lists/*

    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    export PATH="/root/.cargo/bin:${PATH}"

    pip install --no-cache-dir \
        pandas numpy scikit-learn scipy matplotlib seaborn joblib

    mkdir -p /app/gotchao_build

%files
    src          /app/gotchao_build/src
    Cargo.toml   /app/gotchao_build/Cargo.toml
    python       /app/python_scripts

%post
    export PATH="/root/.cargo/bin:${PATH}"
    cd /app/gotchao_build
    cargo build --release
    
    mv target/release/gotchao_core /usr/local/bin/gotchao_core
    chmod +x /usr/local/bin/gotchao_core
    
    cd /
    rm -rf /app/gotchao_build
    rm -rf /root/.cargo

%environment
    export PYTHONPATH="/app/python_scripts:$PYTHONPATH"

%runscript
    exec python3 /app/python_scripts/run_GoTChAo.py "$@"